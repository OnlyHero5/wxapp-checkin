# 微信小程序活动二维码签到需求文档

文档版本: v1.4  
状态: 持续迭代  
更新日期: 2026-02-08  
项目: wxapp-checkin

## 1. 背景与目标
项目为微信小程序前端，提供活动签到相关能力。当前版本目标是：
- 基于角色分流活动页能力（普通用户 / 工作人员）
- 活动页使用卡片模型统一展示与操作
- 支持管理员动态二维码（签到/签退）与普通用户扫码提交
- 支持个人信息与积分展示（普通用户）
- 与后端接口协同，确保联调快速定位

## 2. 范围
范围内:
- 小程序页面交互与角色能力
- 前后端 API 协议对接要求
- 异常提示与状态反馈

范围外:
- 后台管理系统
- 后端部署、权限后台管理

## 3. 角色与用户
- 普通用户（`normal`）
- 有权限工作人员（`staff`）

## 4. 约束与假设
- 微信小程序运行环境
- 二维码滚动更新（默认 10 秒）
- 网络异常时禁止关键动作并提示
- 当前视觉体系基于 TDesign + 深色主题

## 5. 业务流程概述
流程 A: 登录初始化  
调用登录接口换取会话，落地角色与用户资料。

流程 B: 注册绑定  
填写学号与姓名（可选学院/社团）完成身份绑定。

流程 C: 活动浏览与操作  
活动页分“正在进行/已完成”两组展示；工作人员可在进行中活动生成签到/签退二维码，普通用户在“签到/签退”页扫码提交。

流程 D: 查看活动详情  
用户可从卡片进入详情页查看活动完整信息。

## 6. 功能需求

### 6.1 登录与身份
- FR-001 前端需通过微信登录换取 `session_token`
- FR-002 登录返回需包含 `role` 与 `permissions`
- FR-003 登录返回需包含 `user_profile`（含积分字段）
- FR-003A 会话失效时（`status=forbidden` 且 `error_code=session_expired`），前端必须清理本地登录态并切换到登录页重新登录
- FR-003B 后端在 `session_token` 无效或过期时，必须返回机器可识别错误码 `error_code=session_expired`（兼容 `token_expired`）

### 6.2 注册绑定
- FR-004 提供绑定表单（学号、姓名、学院/部门、社团/组织）
- FR-005 学号与姓名必填
- FR-006 绑定成功后缓存用户资料并更新绑定状态
- FR-007 后端必须使用 `student_id + name` 查询管理员名册/权限表，确定最终角色
- FR-007A 命中管理员名册时，注册返回 `staff` 与权限集，前端直接进入管理员活动页
- FR-007B 未命中管理员名册时，注册返回 `normal`，前端进入“我的”页
- FR-007C 同一学号姓名不可被多微信绑定（唯一约束）
- FR-007D 同一微信不可重复绑定其他学号姓名（唯一约束）

### 6.3 活动页（核心）
- FR-008 活动卡片分为 `正在进行` 与 `已完成` 两组
- FR-009 两组都按 `start_time` 倒序（新的在上）
- FR-010 `正在进行` 分组必须位于 `已完成` 分组上方
- FR-011 普通用户活动列表仅返回并展示“已报名/已签到/已签退”活动（`my_registered=true` 或 `my_checked_in=true` 或 `my_checked_out=true`）
- FR-012 普通用户卡片显示“我的状态”（`已报名` / `已签到` / `已签退`）
- FR-013 工作人员卡片显示“签到码”按钮（仅进行中）
- FR-014 `support_checkout=true` 时显示“签退码”按钮（仅进行中）
- FR-015 `has_detail=true` 时显示详情按钮
- FR-016 已完成活动不允许签到/签退（前端与后端双重约束）
- FR-017 工作人员卡片显示 `checkin_count`

### 6.4 动态二维码签到/签退
- FR-018 工作人员在活动页点击“签到码/签退码”后，进入二维码展示页
- FR-019 二维码默认 `10` 秒自动轮换，页面展示“剩余秒数”倒计时
- FR-020 二维码显示有效期结束后，普通用户仍可在 `20` 秒宽限内提交
- FR-021 二维码页支持手动刷新，自动轮换过程应平滑无明显卡顿
- FR-022 二维码页实时显示已签到/已签退人数（至少每 3 秒刷新）
- FR-023 普通用户端提供独立“签到/签退”页面，点击按钮调用摄像头扫码提交
- FR-024 普通用户扫码成功后需即时反馈（Toast + 结果卡），并可返回活动页查看状态

### 6.5 活动详情
- FR-025 详情页展示：名称、类型、开始时间、地点、已签到人数、描述
- FR-026 普通用户仅可查看“已报名/已签到/已签退”活动详情，禁止查看未报名未参加活动
- FR-027 无网时需提示“可能不是最新”

### 6.6 个人中心
- FR-028 展示基础资料：姓名、学号、学院/部门、社团/组织、绑定状态
- FR-029 普通用户展示社会分与讲座分
- FR-030 当前版本不展示“曾参加活动”模块

### 6.7 历史记录能力（当前版本状态）
- FR-031 独立“签到记录列表/详情页”入口在当前版本已下线
- FR-032 `/api/checkin/records*` 接口保留为兼容能力，非当前主验收链路

## 7. 非功能需求
- NFR-001 活动页可在常见网络下快速完成首屏渲染
- NFR-002 扫码动作需有明确 loading 与结果反馈
- NFR-003 二维码轮换与倒计时刷新应平滑，避免明显闪烁或卡顿
- NFR-004 错误文案应可理解并可复现定位
- NFR-005 通信必须走 HTTPS

## 8. API 需求（按当前主链路）

### 8.1 必需接口
- `POST /api/auth/wx-login`
- `POST /api/register`
- `GET /api/staff/activities`
- `POST /api/staff/activities/{activity_id}/qr-session`
- `POST /api/checkin/consume`
- `GET /api/staff/activities/{activity_id}`

### 8.2 保留兼容接口
- `POST /api/checkin/verify`
- `GET /api/checkin/records`
- `GET /api/checkin/records/{record_id}`
- `GET /api/activity/current`

### 8.3 关键字段要求
- 登录接口: `session_token`, `role`, `permissions`, `user_profile.*`
- 注册接口: `role`, `permissions`, `admin_verified`, `is_registered`, `user_profile.*`
- 活动列表接口: `progress_status`, `support_checkout`, `has_detail`, `checkin_count`, `checkout_count`, `my_registered`, `my_checked_in`, `my_checked_out`
- 二维码配置接口: `rotate_seconds`, `grace_seconds`, `server_time`（二维码内容由前端本地生成）
- 扫码提交接口: `status`, `message`, `action_type`, `checkin_record_id`, `in_grace_window`
- 会话失效信号: `status=forbidden`, `error_code=session_expired`, `message=会话失效，请重新登录`

> 详细字段与前端页面映射见 `docs/API_SPEC.md`。

## 9. 验收标准
- 活动页分组与排序规则正确
- 已完成活动仅详情，不能签到/签退
- 普通用户与工作人员展示内容按角色正确分流
- 工作人员二维码页可见倒计时，且每 10 秒前端本地自动换码
- 普通用户在 20 秒宽限内扫码可成功提交，超时返回过期
- 注册绑定后可正确跳转并刷新资料显示
- 关键错误场景（无网/二维码失效/权限不足）有明确提示
- 关键错误场景（会话失效）必须触发跳转登录页并自动重登流程

## 10. 未决问题
- 历史记录页面是否在后续版本重新上线
- 二维码轮换与宽限窗口是否支持按活动级别配置（当前默认 10 秒 + 20 秒）
- 活动列表分页与增量加载策略

## 11. 更新记录
- 2026-02-04：组件库调整为 TDesign，视觉主题升级。
- 2026-02-06：角色分流与活动卡片能力上线。
- 2026-02-07：活动页调整为双分组；已完成活动仅详情；记录页入口下线为兼容保留能力。
- 2026-02-08：普通用户活动可见性收敛为“已报名/已签到/已签退”，详情接口增加同口径鉴权。
- 2026-02-08：新增管理员动态二维码流程（10 秒轮换 + 20 秒宽限），新增普通用户“签到/签退”扫码页。
- 2026-02-08：二维码职责切换为前端本地生成与轮换，后端仅保留业务校验与统计更新。
- 2026-02-08：注册绑定新增“学号+姓名命中管理员名册”角色判定，命中后直接进入管理员页面。
- 2026-02-08：新增会话失效标准信号与前端登录页重登要求（`forbidden + error_code=session_expired`）。
