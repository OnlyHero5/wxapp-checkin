<view class="page page-activities">
  <view class="content">
    <view wx:if="{{!isOnline}}" class="network-banner">当前无网络，无法扫码操作</view>

    <view class="header">
      <text class="title">活动页面</text>
      <view class="title-line"></view>
      <text wx:if="{{role === 'staff'}}" class="subtitle">工作人员可执行签到、签退和详情查看</text>
      <text wx:else class="subtitle">普通用户仅可查看已报名、已签到或已签退活动</text>
    </view>

    <view wx:if="{{loading}}" class="hint">正在加载活动列表...</view>
    <view wx:else class="overview-card">
      <view class="overview-item">
        <text class="overview-value">{{ongoingActivities.length}}</text>
        <text class="overview-label">正在进行</text>
      </view>
      <view class="overview-divider"></view>
      <view class="overview-item">
        <text class="overview-value">{{completedActivities.length}}</text>
        <text class="overview-label">已完成</text>
      </view>
    </view>

    <view wx:if="{{role === 'normal'}}" class="scan-entry-card">
      <view>
        <text class="scan-entry-title">签到/签退</text>
        <text class="scan-entry-desc">前往扫码页面完成签到或签退，结果会同步回活动状态</text>
      </view>
      <t-button theme="primary" size="small" class="scan-entry-btn" disabled="{{!isOnline}}" bindtap="onGoScanPage">去扫码</t-button>
    </view>

    <view wx:if="{{!loading && loadError}}" class="load-error-card">
      <text class="load-error-title">活动列表加载失败</text>
      <text class="load-error-message">{{loadError}}</text>
      <t-button size="small" theme="default" class="load-error-btn" bindtap="onRetryLoad">重试</t-button>
    </view>

    <view wx:for="{{activitySections}}" wx:key="key" wx:for-item="section" class="activity-section" wx:if="{{section.items.length > 0}}">
      <view class="section-head">
        <view class="section-title-wrap">
          <text class="section-title">{{section.title}}</text>
          <text class="section-subtitle">共 {{section.items.length}} 场</text>
        </view>
        <t-tag size="small" theme="{{section.key === 'ongoing' ? 'primary' : 'default'}}" variant="light">
          {{section.key === 'ongoing' ? '优先处理' : '历史归档'}}
        </t-tag>
      </view>

      <view wx:for="{{section.items}}" wx:key="activity_id" wx:for-item="activity" class="activity-card activity-card-{{section.key}}">
        <view class="activity-head">
          <view class="activity-title-wrap">
            <text class="activity-title">{{activity.activity_title}}</text>
            <view class="activity-tag-row">
              <text class="activity-type activity-type-{{activity.type_tone}}">{{activity.activity_type}}</text>
              <t-tag size="small" theme="{{section.key === 'ongoing' ? 'primary' : 'default'}}" variant="light">
                {{section.key === 'ongoing' ? '进行中' : '已完成'}}
              </t-tag>
            </view>
          </view>
        </view>

        <view class="activity-meta-grid">
          <view class="meta-item">
            <text class="meta-label">时间</text>
            <text class="meta-value">{{activity.start_time}}</text>
          </view>
          <view class="meta-item">
            <text class="meta-label">地点</text>
            <text class="meta-value">{{activity.location}}</text>
          </view>
          <view class="meta-item" wx:if="{{role === 'staff'}}">
            <text class="meta-label">已签到</text>
            <text class="meta-value">{{activity.checkin_count}} 人</text>
          </view>
          <view class="meta-item" wx:else>
            <text class="meta-label">我的状态</text>
            <text class="meta-value">{{activity.my_join_status || '未报名'}}</text>
          </view>
        </view>

        <view
          class="activity-actions"
          wx:if="{{(role === 'staff' && section.key === 'ongoing') || activity.has_detail}}"
        >
          <view class="actions-grid">
            <t-button
              wx:if="{{role === 'staff' && section.key === 'ongoing'}}"
              size="small"
              theme="primary"
              class="action-btn"
              data-id="{{activity.activity_id}}"
              bindtap="onTapCheckin"
            >
              签到码
            </t-button>
            <t-button
              wx:if="{{role === 'staff' && section.key === 'ongoing' && activity.support_checkout}}"
              size="small"
              theme="default"
              class="action-btn"
              data-id="{{activity.activity_id}}"
              bindtap="onTapCheckout"
            >
              签退码
            </t-button>
            <t-button
              wx:if="{{activity.has_detail}}"
              size="small"
              theme="default"
              class="action-btn action-btn-detail"
              data-id="{{activity.activity_id}}"
              bindtap="onTapDetail"
            >
              详情
            </t-button>
          </view>
        </view>
      </view>
    </view>

    <app-empty-state
      wx:if="{{!loading && !loadError && ongoingActivities.length === 0 && completedActivities.length === 0}}"
      title="暂无活动卡片"
      message="当前没有可展示的活动，稍后可下拉刷新或重新进入页面查看。"
      action-text="刷新列表"
      show-action="{{isOnline}}"
      bindretry="onRetryLoad"
    />

    <t-cell-group class="status-card" wx:if="{{role === 'staff' && lastStatus}}">
      <t-cell title="{{lastStatus.title}}" note="{{lastStatus.message}}" />
      <t-cell wx:if="{{lastStatus.meta}}" title="记录号" note="{{lastStatus.meta}}" />
    </t-cell-group>
  </view>
</view>
